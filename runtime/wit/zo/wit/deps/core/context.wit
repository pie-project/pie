interface context {

    use wasi:io/poll@0.2.4.{pollable};
    use types.{error};
    use model.{model};

    type page-id = u32;

    resource context {

        // Creates a fresh empty context
        create: static func(model: borrow<model>) -> result<context, error>;

        // Opens a snapshot (implicit fork — snapshot stays immutable)
        open: static func(model: borrow<model>, name: string) -> result<context, error>;

        // Deletes a saved snapshot by name
        delete: static func(model: borrow<model>, name: string) -> result<_, error>;

        // Forks into a new anonymous context
        fork: func() -> result<context, error>;

        // Named save — snapshots committed chain + token metadata under a user-chosen name
        save: func(name: string) -> result<_, error>;

        // Anonymous save — snapshots committed chain + token metadata, returns runtime-generated name
        snapshot: func() -> result<string, error>;

        // Force-destroys immediately
        destroy: func();

        // Number of tokens per page    
        tokens-per-page: func() -> u32;

        model: func() -> model;

        // Number of committed KV pages in the context
        committed-page-count: func() -> u32;

        // Number of uncommitted KV pages in the context
        uncommitted-page-count: func() -> u32;

        // Commit the KV pages to the context
        commit-pages: func(page-indices: list<u32>) -> result<_, error>;

        // Reserve KV pages for the context
        reserve-pages: func(num-pages: u32) -> result<_, error>;

        // Release KV pages from the context
        release-pages: func(num-pages: u32);

        cursor: func() -> u32;

        set-cursor: func(cursor: u32);

        buffered-tokens: func() -> list<u32>;

        set-buffered-tokens: func(tokens: list<u32>);

        append-buffered-tokens: func(tokens: list<u32>);

        last-position: func() -> option<u32>;

    }

}
